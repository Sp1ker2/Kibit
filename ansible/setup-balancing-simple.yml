---
# –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ shell –∫–æ–º–∞–Ω–¥—ã
# PostgreSQL + NFS + Nginx

- name: 1Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL –Ω–∞ Server1
  hosts: master
  become: yes
  tasks:
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL
      apt:
        name:
          - postgresql
          - postgresql-contrib
          - python3-psycopg2
        state: present
        update_cache: yes

    - name: üöÄ –ó–∞–ø—É—Å–∫ PostgreSQL
      systemd:
        name: postgresql
        state: started
        enabled: yes

    - name: üóÑÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –ë–î –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ SQL
      shell: |
        sudo -u postgres psql <<EOF
        -- –°–æ–∑–¥–∞—ë–º –ë–î –µ—Å–ª–∏ –Ω–µ—Ç
        SELECT 'CREATE DATABASE livekit_stream' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'livekit_stream')\gexec
        
        -- –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω–µ—Ç
        DO \$\$
        BEGIN
          IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'livekit_user') THEN
            CREATE USER livekit_user WITH ENCRYPTED PASSWORD 'LiveKit2024SecurePass';
          END IF;
        END
        \$\$;
        
        -- –í—ã–¥–∞—ë–º –ø—Ä–∞–≤–∞
        GRANT ALL PRIVILEGES ON DATABASE livekit_stream TO livekit_user;
        EOF
      args:
        executable: /bin/bash

    - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
      shell: |
        # PostgreSQL –∫–æ–Ω—Ñ–∏–≥
        sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/" /etc/postgresql/14/main/postgresql.conf
        
        # –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        grep -q "195.133.17.0/24" /etc/postgresql/14/main/pg_hba.conf || cat >> /etc/postgresql/14/main/pg_hba.conf <<EOF
        host    livekit_stream    livekit_user    195.133.17.0/24     md5
        host    livekit_stream    livekit_user    195.133.39.0/24     md5
        EOF
        
        # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
        systemctl restart postgresql
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç
        sleep 2
        netstat -tuln | grep 5432

- name: 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NFS –Ω–∞ Server1
  hosts: master
  become: yes
  tasks:
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NFS —Å–µ—Ä–≤–µ—Ä–∞
      apt:
        name: nfs-kernel-server
        state: present

    - name: üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ recordings
      file:
        path: /www/wwwroot/LiveKit/recordings
        state: directory
        mode: '0777'

    - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ NFS —ç–∫—Å–ø–æ—Ä—Ç–∞
      shell: |
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
        sed -i '/recordings/d' /etc/exports
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é
        echo "/www/wwwroot/LiveKit/recordings 195.133.17.179(rw,sync,no_subtree_check,no_root_squash) 195.133.39.17(rw,sync,no_subtree_check,no_root_squash) 195.133.39.33(rw,sync,no_subtree_check,no_root_squash) 195.133.39.41(rw,sync,no_subtree_check,no_root_squash)" >> /etc/exports
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º
        exportfs -ra
        systemctl restart nfs-kernel-server
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º
        showmount -e localhost

- name: 3Ô∏è‚É£ –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ NFS –Ω–∞ Server2-5
  hosts: workers
  become: yes
  tasks:
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NFS –∫–ª–∏–µ–Ω—Ç–∞
      apt:
        name: nfs-common
        state: present

    - name: üîó –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ NFS
      shell: |
        # –†–∞–∑–º–æ–Ω—Ç–∏—Ä—É–µ–º –µ—Å–ª–∏ –±—ã–ª–æ
        umount /www/wwwroot/LiveKit/recordings 2>/dev/null || true
        
        # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É
        mkdir -p /www/wwwroot/LiveKit/recordings
        
        # –ú–æ–Ω—Ç–∏—Ä—É–µ–º
        mount -t nfs 195.133.17.131:/www/wwwroot/LiveKit/recordings /www/wwwroot/LiveKit/recordings
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ fstab
        grep -q "195.133.17.131:/www/wwwroot/LiveKit/recordings" /etc/fstab || echo "195.133.17.131:/www/wwwroot/LiveKit/recordings /www/wwwroot/LiveKit/recordings nfs defaults 0 0" >> /etc/fstab
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º
        df -h | grep recordings

- name: 4Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö
  hosts: all
  become: yes
  tasks:
    - name: üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ db-postgres.js
      copy:
        src: ../streamApp/server/db-postgres.js
        dest: /www/wwwroot/LiveKit/streamApp/server/db-postgres.js
        mode: '0644'

    - name: üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ api.js
      copy:
        src: ../streamApp/server/api.js
        dest: /www/wwwroot/LiveKit/streamApp/server/api.js
        mode: '0644'

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pg –¥—Ä–∞–π–≤–µ—Ä–∞
      shell: |
        cd /www/wwwroot/LiveKit/streamApp
        npm install pg

    - name: üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ API
      shell: pkill -f 'node server/api.js' || true

    - name: ‚è±Ô∏è –ü–∞—É–∑–∞
      pause:
        seconds: 3

    - name: üöÄ –ó–∞–ø—É—Å–∫ API —Å PostgreSQL
      shell: |
        cd /www/wwwroot/LiveKit/streamApp
        USE_POSTGRES=true nohup node server/api.js > /tmp/api-postgres.log 2>&1 &
      environment:
        USE_POSTGRES: "true"

    - name: ‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
      pause:
        seconds: 5

    - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ API
      shell: |
        echo "=== API Status ==="
        ps aux | grep 'node server/api.js' | grep -v grep
        echo ""
        echo "=== API Response ==="
        curl -s http://localhost:3001/api/room-list | head -100
      register: api_status

    - name: üìä –†–µ–∑—É–ª—å—Ç–∞—Ç
      debug:
        msg: "{{ api_status.stdout_lines }}"

- name: 5Ô∏è‚É£ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Nginx
  hosts: master
  become: yes
  tasks:
    - name: üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ —Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π
      copy:
        src: ../nginx-balancer.conf
        dest: /etc/nginx/sites-available/kibitkostreamappv.pp.ua
        backup: yes

    - name: ‚úÖ –¢–µ—Å—Ç –∫–æ–Ω—Ñ–∏–≥–∞
      command: nginx -t

    - name: üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx
      systemd:
        name: nginx
        state: reloaded

    - name: üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
      shell: |
        for i in {1..10}; do
          curl -s https://kibitkostreamappv.pp.ua/api/room-list > /dev/null && echo "Request $i: OK"
        done
      register: balance_test

    - name: ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
      debug:
        msg: "{{ balance_test.stdout_lines }}"

