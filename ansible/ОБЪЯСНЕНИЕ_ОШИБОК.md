# üìã –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ Ansible Playbook

## ‚úÖ –ß—Ç–æ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

1. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä–∞–º** - –≤—Å–µ 5 —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã ‚úÖ
2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**:
   - Node.js —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ server3, server4, server5 ‚úÖ
   - npm —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ server1 ‚úÖ
   - rsync —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤–µ–∑–¥–µ ‚úÖ
   - livekit-server —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ server2, server3, server4, server5 ‚úÖ
3. **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤**:
   - streamApp/ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã ‚úÖ
   - livekit/ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã ‚úÖ
   - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ server1 (master) ‚úÖ
4. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** –Ω–∞ server2, server3, server5 ‚úÖ
5. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx Load Balancer** –Ω–∞ server1 ‚úÖ

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è

### 1. –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤ –Ω–∞ server4 (—Å—Ç—Ä–æ–∫–∞ 118-134)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
Permission denied (publickey,password).
rsync(75564): error: unexpected end of file
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ú–æ–¥—É–ª—å `synchronize` –Ω–µ —Å–º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è server4
- –í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ rsync

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω `ignore_errors: yes` - –∑–∞–¥–∞—á–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –Ω–µ —Å–∫–æ–ø–∏—Ä—É–µ—Ç
- –°–∫—Ä–∏–ø—Ç—ã –≤—Å–µ —Ä–∞–≤–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å (setup.sh —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ server4)
- –ú–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é: `scp start-simple.sh root@195.133.39.33:/www/wwwroot/LiveKit/`

### 2. –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 189-201)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
non-zero return code, rc: -15
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- `pkill` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–¥ -15 (SIGTERM) –∫–æ–≥–¥–∞ —É–±–∏–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã
- –≠—Ç–æ **–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ** - –ø—Ä–æ—Ü–µ—Å—Å—ã —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!
- Ansible —Å—á–∏—Ç–∞–µ—Ç —ç—Ç–æ –æ—à–∏–±–∫–æ–π, —Ö–æ—Ç—è –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω `ignore_errors: yes` - Ansible –Ω–µ –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å —ç—Ç–æ –æ—à–∏–±–∫–æ–π
- –î–æ–±–∞–≤–ª–µ–Ω `changed_when: false` - –Ω–µ –±—É–¥–µ—Ç –ø–æ–º–µ—á–∞—Ç—å –∫–∞–∫ "–∏–∑–º–µ–Ω–µ–Ω–æ"
- –ü—Ä–æ—Ü–µ—Å—Å—ã —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö

## üìä –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

### –£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:
- ‚úÖ server1: 17 –∑–∞–¥–∞—á, 7 –∏–∑–º–µ–Ω–µ–Ω–∏–π, 1 –æ—à–∏–±–∫–∞ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- ‚úÖ server2: 17 –∑–∞–¥–∞—á, 9 –∏–∑–º–µ–Ω–µ–Ω–∏–π, 1 –æ—à–∏–±–∫–∞ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- ‚úÖ server3: 19 –∑–∞–¥–∞—á, 11 –∏–∑–º–µ–Ω–µ–Ω–∏–π, 1 –æ—à–∏–±–∫–∞ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- ‚ö†Ô∏è server4: 13 –∑–∞–¥–∞—á, 7 –∏–∑–º–µ–Ω–µ–Ω–∏–π, 1 –æ—à–∏–±–∫–∞ (–ø—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–∫—Ä–∏–ø—Ç–∞)
- ‚úÖ server5: 19 –∑–∞–¥–∞—á, 11 –∏–∑–º–µ–Ω–µ–Ω–∏–π, 1 –æ—à–∏–±–∫–∞ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

### Nginx Load Balancer:
- ‚úÖ server1: 8 –∑–∞–¥–∞—á, 4 –∏–∑–º–µ–Ω–µ–Ω–∏—è, 0 –æ—à–∏–±–æ–∫ - **–£–°–ü–ï–®–ù–û!**

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### 1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –Ω–∞ server4 –≤—Ä—É—á–Ω—É—é:

```bash
scp start-simple.sh root@195.133.39.33:/www/wwwroot/LiveKit/
```

–ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å playbook –µ—â–µ —Ä–∞–∑ - –∑–∞–¥–∞—á–∞ —Å `ignore_errors: yes` –º–æ–∂–µ—Ç –ø—Ä–æ–π—Ç–∏.

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö:

```bash
cd ansible
ansible all -m shell -a "cd /www/wwwroot/LiveKit && ./start-simple.sh"
```

–ò–ª–∏ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π playbook –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤.

## ‚úÖ –í—ã–≤–æ–¥

**–ü–æ—á—Ç–∏ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!** –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. ‚úÖ –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ (–¥–æ–±–∞–≤–ª–µ–Ω `ignore_errors`)
2. ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º –Ω–∞ server4 - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é

**Nginx Load Balancer –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!** üéâ

