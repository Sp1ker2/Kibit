---
# Простое обновление Node.js через nvm

- name: Обновление Node.js через nvm
  hosts: server1,server2
  become: yes
  
  tasks:
    - name: Установка nvm если не установлен
      shell: |
        if [ ! -d "$HOME/.nvm" ]; then
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        fi
      args:
        creates: /root/.nvm

    - name: Загрузка nvm и установка Node.js 20
      shell: |
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm install 20
        nvm use 20
        nvm alias default 20
        ln -sf $(which node) /usr/local/bin/node
        ln -sf $(which npm) /usr/local/bin/npm
      environment:
        NVM_DIR: "/root/.nvm"

    - name: Проверка версии Node.js
      command: node --version
      register: node_check
      changed_when: false

    - name: Вывод версии
      debug:
        msg: "Node.js: {{ node_check.stdout }}"

