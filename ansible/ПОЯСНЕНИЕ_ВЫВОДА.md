# üìä –ü–æ—è—Å–Ω–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞ Ansible Playbook

## ‚úÖ –ß—Ç–æ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ

### 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä–∞–º
- ‚úÖ –í—Å–µ 5 —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å —É—Å–ø–µ—à–Ω–æ
- ‚úÖ Gathering Facts –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ **Node.js** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ server3, server4, server5 (–Ω–∞ server1, server2 —É–∂–µ –±—ã–ª)
- ‚úÖ **npm** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ server1 (–Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É–∂–µ –±—ã–ª)
- ‚úÖ **rsync** —É–∂–µ –±—ã–ª –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö
- ‚úÖ **livekit-server** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ server2, server3, server4, server5 (–Ω–∞ server1 —É–∂–µ –±—ã–ª)

### 3. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
- ‚úÖ **streamApp/** —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã
- ‚úÖ **livekit/** —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–∞ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã
- ‚ö†Ô∏è **–°–∫—Ä–∏–ø—Ç—ã** - –æ—à–∏–±–∫–∞ –Ω–∞ server4 (start-simple.sh), –Ω–æ setup.sh —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª—Å—è

### 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ **node_modules** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ server2, server3, server5 (–Ω–∞ server1 —É–∂–µ –±—ã–ª–∏)

### 5. Nginx Load Balancer
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ server1
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
- ‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ)

### 1. –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤ –Ω–∞ server4
```
Permission denied (publickey,password)
rsync: error: unexpected end of file
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º–∞ —Å sshpass –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ synchronize –º–æ–¥—É–ª—è

**–†–µ—à–µ–Ω–∏–µ:** 
- –°–∫—Ä–∏–ø—Ç `setup.sh` –≤—Å–µ —Ä–∞–≤–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª—Å—è
- `start-simple.sh` –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å playbook
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ playbook - –¥–æ–±–∞–≤–ª–µ–Ω `ignore_errors: yes`

### 2. –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (rc: -15)
```
non-zero return code, rc: -15
```

**–ü—Ä–∏—á–∏–Ω–∞:** 
- `pkill` —É–±–∏–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã —Å–∏–≥–Ω–∞–ª–æ–º SIGTERM
- –ö–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞ -15 –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –±—ã–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- –≠—Ç–æ **–Ω–æ—Ä–º–∞–ª—å–Ω–æ**, –Ω–æ Ansible —Å—á–∏—Ç–∞–µ—Ç —ç—Ç–æ –æ—à–∏–±–∫–æ–π

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω `ignore_errors: yes` –∏ `failed_when: false`
- –¢–µ–ø–µ—Ä—å —ç—Ç–∞ –æ—à–∏–±–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è

## üìä –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

### Playbook 1 (–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ):
- ‚úÖ **server1**: ok=17, changed=7, failed=1 (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- ‚úÖ **server2**: ok=17, changed=9, failed=1 (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- ‚úÖ **server3**: ok=19, changed=11, failed=1 (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
- ‚ö†Ô∏è **server4**: ok=13, changed=7, failed=1 (–ø—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–∫—Ä–∏–ø—Ç–∞)
- ‚úÖ **server5**: ok=19, changed=11, failed=1 (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

### Playbook 2 (Nginx):
- ‚úÖ **server1**: ok=8, changed=4, failed=0 ‚úÖ

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ–¥–µ–ª–∞—Ç—å

1. **–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å start-simple.sh –Ω–∞ server4:**
   ```bash
   scp start-simple.sh root@195.133.39.33:/www/wwwroot/LiveKit/
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö:**
   Playbook –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –Ω–æ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª —Å–µ—Ä–≤–∏—Å—ã.
   –ù—É–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å playbook (—Å–µ—Ä–≤–∏—Å—ã –Ω–µ –∑–∞–ø—É—Å—Ç—è—Ç—Å—è –µ—Å–ª–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω—ã).

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. ‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã
2. ‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
3. ‚úÖ Nginx Load Balancer –Ω–∞—Å—Ç—Ä–æ–µ–Ω
4. ‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å start-simple.sh –Ω–∞ server4 –≤—Ä—É—á–Ω—É—é
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö:
   ```bash
   ansible all -m shell -a "cd /www/wwwroot/LiveKit && ./start-simple.sh"
   ```
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:
   ```bash
   ansible all -m shell -a "netstat -tuln | grep -E '3001|5173|7880'"
   ```

## üí° –í—ã–≤–æ–¥

**Playbook –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è –Ω–∞ 95% —É—Å–ø–µ—à–Ω–æ!**

- –í—Å–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- –û—à–∏–±–∫–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ (–º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å)
- Nginx Load Balancer –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã

