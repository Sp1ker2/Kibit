---
# üöÄ –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞ 5 —Å–µ—Ä–≤–µ—Ä–∞—Ö
# PostgreSQL + NFS + Nginx –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞

- name: –®–∞–≥ 1 - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ
  hosts: master
  become: yes
  tasks:
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL
      apt:
        name:
          - postgresql
          - postgresql-contrib
        state: present
        update_cache: yes

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ python3-psycopg2 –¥–ª—è Ansible
      apt:
        name: python3-psycopg2
        state: present

    - name: üöÄ –ó–∞–ø—É—Å–∫ PostgreSQL
      systemd:
        name: postgresql
        state: started
        enabled: yes

    - name: üóÑÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      become_user: postgres
      postgresql_db:
        name: livekit_stream
        state: present

    - name: üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î
      become_user: postgres
      postgresql_user:
        name: livekit_user
        password: LiveKit2024SecurePass
        role_attr_flags: CREATEDB,NOSUPERUSER
        state: present
    
    - name: üîë –í—ã–¥–∞—á–∞ –ø—Ä–∞–≤ –Ω–∞ –ë–î
      become_user: postgres
      postgresql_privs:
        database: livekit_stream
        roles: livekit_user
        privs: ALL
        type: database
        state: present

    - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ - postgresql.conf
      lineinfile:
        path: /etc/postgresql/14/main/postgresql.conf
        regexp: '^#?listen_addresses'
        line: "listen_addresses = '*'"
        backup: yes
      notify: restart postgresql

    - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ - pg_hba.conf
      blockinfile:
        path: /etc/postgresql/14/main/pg_hba.conf
        block: |
          # –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
          host    livekit_stream    livekit_user    195.133.17.0/24     md5
          host    livekit_stream    livekit_user    195.133.39.0/24     md5
        backup: yes
      notify: restart postgresql

  handlers:
    - name: restart postgresql
      systemd:
        name: postgresql
        state: restarted

- name: –®–∞–≥ 2 - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NFS —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ
  hosts: master
  become: yes
  tasks:
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NFS —Å–µ—Ä–≤–µ—Ä–∞
      apt:
        name: nfs-kernel-server
        state: present

    - name: üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ recordings
      file:
        path: /www/wwwroot/LiveKit/recordings
        state: directory
        mode: '0777'
        owner: root
        group: root

    - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ NFS
      lineinfile:
        path: /etc/exports
        line: "/www/wwwroot/LiveKit/recordings 195.133.17.179(rw,sync,no_subtree_check,no_root_squash) 195.133.39.17(rw,sync,no_subtree_check,no_root_squash) 195.133.39.33(rw,sync,no_subtree_check,no_root_squash) 195.133.39.41(rw,sync,no_subtree_check,no_root_squash)"
        create: yes
        backup: yes

    - name: üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∞ NFS
      command: exportfs -ra

    - name: üöÄ –ó–∞–ø—É—Å–∫ NFS —Å–µ—Ä–≤–µ—Ä–∞
      systemd:
        name: nfs-kernel-server
        state: restarted
        enabled: yes

- name: –®–∞–≥ 3 - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NFS –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ workers
  hosts: workers
  become: yes
  tasks:
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NFS –∫–ª–∏–µ–Ω—Ç–∞
      apt:
        name: nfs-common
        state: present

    - name: üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      file:
        path: /www/wwwroot/LiveKit/recordings
        state: directory
        mode: '0777'

    - name: üîó –ú–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ NFS
      mount:
        path: /www/wwwroot/LiveKit/recordings
        src: 195.133.17.131:/www/wwwroot/LiveKit/recordings
        fstype: nfs
        opts: defaults
        state: mounted

    - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      command: df -h /www/wwwroot/LiveKit/recordings
      register: nfs_check
      changed_when: false

    - name: üìä –í—ã–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ NFS
      debug:
        msg: "{{ nfs_check.stdout }}"

- name: –®–∞–≥ 4 - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö
  hosts: all
  become: yes
  tasks:
    - name: üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ server —Ñ–∞–π–ª–æ–≤
      copy:
        src: "../streamApp/server/{{ item }}"
        dest: /www/wwwroot/LiveKit/streamApp/server/{{ item }}
        mode: '0644'
      loop:
        - api.js
        - db.js
        - db-postgres.js

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pg –¥—Ä–∞–π–≤–µ—Ä–∞
      npm:
        name: pg
        path: /www/wwwroot/LiveKit/streamApp
        state: present

    - name: üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ API
      shell: pkill -f 'node server/api.js' || true

    - name: ‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
      pause:
        seconds: 2

    - name: üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ API —Å PostgreSQL
      shell: |
        cd /www/wwwroot/LiveKit/streamApp
        USE_POSTGRES=true nohup node server/api.js > /tmp/api.log 2>&1 &
      environment:
        USE_POSTGRES: "true"

    - name: ‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
      pause:
        seconds: 3

    - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ API
      shell: curl -s http://localhost:3001/api/room-list | head -50
      register: api_check
      changed_when: false

    - name: üìä –°—Ç–∞—Ç—É—Å API
      debug:
        msg: "{{ api_check.stdout }}"

- name: –®–∞–≥ 5 - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Nginx –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ
  hosts: master
  become: yes
  tasks:
    - name: üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Nginx –∫–æ–Ω—Ñ–∏–≥–∞ —Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π
      copy:
        src: ../nginx-balancer.conf
        dest: /etc/nginx/sites-available/kibitkostreamappv.pp.ua
        backup: yes

    - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ Nginx
      command: nginx -t
      register: nginx_test
      changed_when: false

    - name: üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx
      systemd:
        name: nginx
        state: reloaded
      when: nginx_test.rc == 0

- name: –®–∞–≥ 6 - –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
  hosts: all
  become: yes
  tasks:
    - name: üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
      shell: |
        echo "=== –°–µ—Ä–≤–µ—Ä: $(hostname) ==="
        echo "PostgreSQL: $(systemctl is-active postgresql 2>/dev/null || echo 'N/A (worker)')"
        echo "NFS Mount: $(df -h /www/wwwroot/LiveKit/recordings 2>/dev/null | grep -q '195.133.17.131' && echo 'Mounted' || echo 'Local')"
        echo "API: $(ps aux | grep 'node server/api.js' | grep -v grep > /dev/null && echo 'Running' || echo 'Stopped')"
        echo "LiveKit: $(ps aux | grep 'livekit-server' | grep -v grep > /dev/null && echo 'Running' || echo 'Stopped')"
        echo "API Port: $(netstat -tuln | grep ':3001' > /dev/null && echo 'Listening' || echo 'Not listening')"
        echo "LiveKit Port: $(netstat -tuln | grep ':7880' > /dev/null && echo 'Listening' || echo 'Not listening')"
      register: final_status
      changed_when: false

    - name: ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
      debug:
        msg: "{{ final_status.stdout_lines }}"

