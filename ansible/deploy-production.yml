---
# Ansible Playbook –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è PRODUCTION –≤–µ—Ä—Å–∏–∏ –Ω–∞ 5 —Å–µ—Ä–≤–µ—Ä–∞—Ö
# Server1 = –º–∞—Å—Ç–µ—Ä (–ë–î + —Å—Ç–∞—Ç–∏–∫–∞), –æ—Å—Ç–∞–ª—å–Ω—ã–µ = workers (—Ç–æ–ª—å–∫–æ API + LiveKit)

- name: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Production LiveKit Stream App
  hosts: all
  become: yes
  gather_facts: yes
  
  tasks:
    - name: üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä–∞–º
      ping:

    # ===== –û–ë–©–ò–ï –ó–ê–î–ê–ß–ò –î–õ–Ø –í–°–ï–• –°–ï–†–í–ï–†–û–í =====
    
    - name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ project_path }}"
        - "{{ project_path }}/streamApp"
        - "{{ project_path }}/livekit"
        - "{{ project_path }}/recordings"

    - name: üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ streamApp (–±–µ–∑ node_modules –∏ –ë–î)
      synchronize:
        src: "../streamApp/"
        dest: "{{ project_path }}/streamApp/"
        delete: no
        rsync_opts:
          - "--exclude=node_modules"
          - "--exclude=.git"
          - "--exclude=*.log"
          - "--exclude=*.db-journal"
          - "--exclude=database.db"
          - "--exclude=dist"
      delegate_to: localhost

    - name: üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ dist (—Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞)
      synchronize:
        src: "../streamApp/dist/"
        dest: "{{ project_path }}/streamApp/dist/"
        delete: yes
      delegate_to: localhost

    - name: üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ livekit –∫–æ–Ω—Ñ–∏–≥–æ–≤
      synchronize:
        src: "../livekit/"
        dest: "{{ project_path }}/livekit/"
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=*.log"
      delegate_to: localhost

    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      shell: |
        cd {{ project_path }}/streamApp
        if [ ! -d "node_modules" ]; then
          npm install --production
        fi

    # ===== –ú–ê–°–¢–ï–† –°–ï–†–í–ï–† (Server1) - –ë–î + NGINX =====
    
    - name: üóÑÔ∏è –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î –Ω–∞ –º–∞—Å—Ç–µ—Ä —Å–µ—Ä–≤–µ—Ä
      copy:
        src: "../streamApp/database.db"
        dest: "{{ project_path }}/streamApp/database.db"
        mode: '0644'
      when: server_role == "master"

    - name: üåê –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Nginx –∫–æ–Ω—Ñ–∏–≥–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä
      copy:
        src: "../nginx-single-server.conf"
        dest: "/etc/nginx/sites-available/{{ domain }}"
        mode: '0644'
      when: server_role == "master"

    - name: üîó –ê–∫—Ç–∏–≤–∞—Ü–∏—è Nginx –∫–æ–Ω—Ñ–∏–≥–∞
      file:
        src: "/etc/nginx/sites-available/{{ domain }}"
        dest: "/etc/nginx/sites-enabled/{{ domain }}"
        state: link
      when: server_role == "master"

    - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx
      shell: |
        nginx -t && systemctl reload nginx
      when: server_role == "master"
      ignore_errors: yes

    # ===== –ó–ê–ü–£–°–ö –°–ï–†–í–ò–°–û–í –ù–ê –í–°–ï–• –°–ï–†–í–ï–†–ê–• =====
    
    - name: üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
      shell: |
        pkill -f "livekit-server" || true
        pkill -f "node server/api.js" || true
        sleep 2

    - name: üöÄ –ó–∞–ø—É—Å–∫ LiveKit —Å–µ—Ä–≤–µ—Ä–∞
      shell: |
        cd {{ project_path }}/livekit
        nohup livekit-server --dev --bind 0.0.0.0 --port {{ livekit_port }} > /tmp/livekit.log 2>&1 &
        sleep 2

    - name: üöÄ –ó–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–µ—Ä–∞
      shell: |
        cd {{ project_path }}/streamApp
        nohup node server/api.js > /tmp/api.log 2>&1 &
        sleep 2

    # ===== –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê =====
    
    - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
      shell: |
        echo "=== –ü–æ—Ä—Ç—ã ==="
        netstat -tuln | grep -E '{{ api_port }}|{{ livekit_port }}' || ss -tuln | grep -E '{{ api_port }}|{{ livekit_port }}'
        echo ""
        echo "=== –ü—Ä–æ—Ü–µ—Å—Å—ã ==="
        ps aux | grep -E 'livekit-server|node server/api.js' | grep -v grep
      register: status_check
      changed_when: false
      failed_when: false

    - name: üìä –í—ã–≤–æ–¥ —Å—Ç–∞—Ç—É—Å–∞
      debug:
        msg: "{{ status_check.stdout_lines }}"

    # ===== –ò–¢–û–ì–û–í–´–ô –û–¢–ß–Å–¢ =====
    
    - name: üìã –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      shell: |
        echo "üñ•Ô∏è  –°–µ—Ä–≤–µ—Ä: {{ inventory_hostname }}"
        echo "üìç –†–æ–ª—å: {{ server_role }}"
        echo "üåê LiveKit: $(pgrep -f livekit-server > /dev/null && echo '‚úÖ –ó–∞–ø—É—â–µ–Ω' || echo '‚ùå –ù–µ –∑–∞–ø—É—â–µ–Ω')"
        echo "üîå API: $(pgrep -f 'node server/api.js' > /dev/null && echo '‚úÖ –ó–∞–ø—É—â–µ–Ω' || echo '‚ùå –ù–µ –∑–∞–ø—É—â–µ–Ω')"
        if [ "{{ server_role }}" = "master" ]; then
          echo "üóÑÔ∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $([ -f {{ project_path }}/streamApp/database.db ] && echo '‚úÖ –ù–∞–π–¥–µ–Ω–∞' || echo '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞')"
          echo "üìÅ –°—Ç–∞—Ç–∏–∫–∞: $([ -d {{ project_path }}/streamApp/dist ] && echo '‚úÖ –ù–∞–π–¥–µ–Ω–∞' || echo '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞')"
        fi
      register: final_status
      changed_when: false

    - name: ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
      debug:
        msg: "{{ final_status.stdout_lines }}"

