#!/bin/bash
# ะขะตัั ะฟััะผะพะณะพ ะฟะพะดะบะปััะตะฝะธั ะบ LiveKit ะฝะฐ ะฟะพััั 7880

echo "๐ ะขะตััะธัะพะฒะฐะฝะธะต ะฟััะผะพะณะพ ะฟะพะดะบะปััะตะฝะธั ะบ LiveKit..."
echo ""

DOMAIN="kibitkostreamappv.pp.ua"
PORT="7880"

# ะัะพะฒะตัะบะฐ ะฟะพััะฐ
echo "1. ะัะพะฒะตัะบะฐ ะฟะพััะฐ $PORT:"
if netstat -tulpn 2>/dev/null | grep -q ":$PORT " || ss -tulpn 2>/dev/null | grep -q ":$PORT "; then
    echo "โ ะะพัั $PORT ัะปััะฐะตััั"
    netstat -tulpn 2>/dev/null | grep "$PORT" || ss -tulpn 2>/dev/null | grep "$PORT"
else
    echo "โ ะะพัั $PORT ะะ ัะปััะฐะตััั"
fi
echo ""

# ะัะพะฒะตัะบะฐ firewall
echo "2. ะัะพะฒะตัะบะฐ firewall ะดะปั ะฟะพััะฐ $PORT:"
if ufw status | grep -q "$PORT"; then
    echo "โ ะะพัั $PORT ะพัะบััั ะฒ firewall"
    ufw status | grep "$PORT"
else
    echo "โ๏ธ  ะะพัั $PORT ะผะพะถะตั ะฑััั ะทะฐะบััั ะฒ firewall"
    echo "   ะัะบัะพะนัะต: sudo ufw allow $PORT/tcp"
fi
echo ""

# ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะฟะพ HTTP
echo "3. ะัะพะฒะตัะบะฐ HTTP ะฟะพะดะบะปััะตะฝะธั ะบ ะฟะพััั $PORT:"
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 3 http://localhost:$PORT 2>&1)
if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "404" ] || [ "$HTTP_CODE" = "405" ]; then
    echo "โ LiveKit ะพัะฒะตัะฐะตั ะฝะฐ HTTP ะทะฐะฟัะพัั (ะบะพะด: $HTTP_CODE)"
else
    echo "โ๏ธ  LiveKit ะฝะต ะพัะฒะตัะฐะตั ะฝะฐ HTTP ะทะฐะฟัะพัั (ะบะพะด: $HTTP_CODE)"
fi
echo ""

# ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะฟะพ HTTPS/WSS
echo "4. ะัะพะฒะตัะบะฐ HTTPS/WSS ะฟะพะดะบะปััะตะฝะธั ะบ ะฟะพััั $PORT:"
echo "   โ๏ธ  LiveKit ะฒ dev ัะตะถะธะผะต ะพะฑััะฝะพ ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะตั SSL ะฝะฐะฟััะผัั"
echo "   ะัะถะตะฝ SSL ัะตัะผะธะฝะธัะพะฒะฐะฝะธะต ะธะปะธ ะธัะฟะพะปัะทะพะฒะฐะฝะธะต HTTP/WS ะดะปั dev ัะตะถะธะผะฐ"
echo ""

# ะัะพะฒะตัะบะฐ ะธะทะฒะฝะต
echo "5. ะัะพะฒะตัะบะฐ ะฒะฝะตัะฝะตะณะพ ะฟะพะดะบะปััะตะฝะธั:"
echo "   ะขะตััะธััะตะผ ั ัะตัะฒะตัะฐ..."
EXTERNAL_TEST=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 "http://${DOMAIN}:${PORT}" 2>&1)
if echo "$EXTERNAL_TEST" | grep -q "200\|404\|405"; then
    echo "โ ะะฝะตัะฝะตะต ะฟะพะดะบะปััะตะฝะธะต ัะฐะฑะพัะฐะตั (ะบะพะด: $EXTERNAL_TEST)"
else
    echo "โ ะะฝะตัะฝะตะต ะฟะพะดะบะปััะตะฝะธะต ะฝะต ัะฐะฑะพัะฐะตั (ะบะพะด: $EXTERNAL_TEST)"
    echo "   ะะพะทะผะพะถะฝัะต ะฟัะธัะธะฝั:"
    echo "   - ะะพัั ะทะฐะบััั ะฒ firewall"
    echo "   - LiveKit ัะปััะฐะตั ัะพะปัะบะพ ะฝะฐ localhost"
    echo "   - ะัะถะตะฝ SSL ะดะปั WSS"
fi
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ก ะะะะะะะะะะฆะะ:"
echo ""
echo "ะะปั dev ัะตะถะธะผะฐ LiveKit ะปัััะต ะธัะฟะพะปัะทะพะฒะฐัั HTTP/WS:"
echo "  ws://${DOMAIN}:${PORT}  (ะฐ ะฝะต wss://)"
echo ""
echo "ะะปะธ ะฝะฐัััะพะธัั Nginx ะดะปั ะฟัะพะบัะธัะพะฒะฐะฝะธั WebSocket ั SSL:"
echo "  - ะะปะธะตะฝั ะฟะพะดะบะปััะฐะตััั: wss://${DOMAIN}/rtc"
echo "  - Nginx ะฟัะพะบัะธััะตั ะฝะฐ: ws://127.0.0.1:7880/rtc"
echo "  - SSL ัะตัะผะธะฝะธััะตััั ะฒ Nginx"
echo ""
echo "ะัะปะธ ะฝัะถะตะฝ SSL ะดะปั ะฟััะผะพะณะพ ะฟะพะดะบะปััะตะฝะธั:"
echo "  - ะัะถะฝะพ ะฝะฐัััะพะธัั SSL ะฝะฐ LiveKit ัะตัะฒะตัะต"
echo "  - ะะปะธ ะธัะฟะพะปัะทะพะฒะฐัั reverse proxy (Nginx)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

