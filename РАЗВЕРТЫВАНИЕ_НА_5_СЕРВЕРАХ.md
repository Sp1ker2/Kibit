# üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ LiveKit Stream App –Ω–∞ 5 —Å–µ—Ä–≤–µ—Ä–∞—Ö

## üìã –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ 5 —Å–µ—Ä–≤–µ—Ä–∞—Ö —Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ Nginx –∏–ª–∏ Kubernetes.

## üñ•Ô∏è –°–µ—Ä–≤–µ—Ä—ã

| IP | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å | –ü–∞—Ä–æ–ª—å | –ü–æ—Ä—Ç SSH |
|---|---|---|---|
| 195.133.17.131 | root | iFG02M6Z | 16205 |
| 195.133.17.179 | root | kSE2oBmk | 35614 |
| 195.133.39.17 | root | 66AMoRNN | 13845 |
| 195.133.39.33 | root | vHdUm7B2 | 42460 |
| 195.133.39.41 | root | EReAGUNX | 31966 |

**–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä:** 195.133.17.131 (–Ω–∞ –Ω–µ–º –±—É–¥–µ—Ç Nginx Load Balancer)

## üîß –í–∞—Ä–∏–∞–Ω—Ç 1: Nginx Load Balancer (–ü—Ä–æ—â–µ)

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ sshpass (–¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏)

```bash
# macOS
brew install hudochenkov/sshpass/sshpass

# Linux
sudo apt-get install sshpass
```

### –®–∞–≥ 2: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö

```bash
chmod +x deploy-to-all-servers.sh
./deploy-to-all-servers.sh
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
- –ö–æ–ø–∏—Ä—É–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–µ—Ä
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (npm install)
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
- –ö–æ–ø–∏—Ä—É–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx Load Balancer –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ

```bash
# –ù–∞ –≥–ª–∞–≤–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ (195.133.17.131)
chmod +x setup-load-balancer.sh
./setup-load-balancer.sh

# –ó–∞—Ç–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã –∫–æ—Ç–æ—Ä—ã–µ —Å–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ—Ç:
sudo cp /tmp/nginx-lb.conf /etc/nginx/sites-available/streamapp-lb
sudo ln -sf /etc/nginx/sites-available/streamapp-lb /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### –®–∞–≥ 4: –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–æ–≤ –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ:

```bash
sudo ufw allow 3001/tcp
sudo ufw allow 5173/tcp
sudo ufw allow 7880/tcp
sudo ufw allow 7880/udp
```

### –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö

```bash
chmod +x start-all-servers.sh
./start-all-servers.sh
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å—Ç–∏—Ç –Ω–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ:
- LiveKit —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 7880)
- API —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 3001)
- Frontend —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 5173)

### –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
chmod +x check-all-servers.sh
./check-all-servers.sh
```

## üîß –í–∞—Ä–∏–∞–Ω—Ç 2: Kubernetes (K8s) - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Kubernetes –∫–ª–∞—Å—Ç–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- kubectl —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- –î–æ—Å—Ç—É–ø –∫ –∫–ª–∞—Å—Ç–µ—Ä—É

### –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

```bash
# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
kubectl apply -f k8s-deployment.yaml

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å
kubectl get pods -n streamapp
kubectl get services -n streamapp

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
kubectl logs -f deployment/streamapp-api -n streamapp
kubectl logs -f deployment/streamapp-frontend -n streamapp
kubectl logs -f deployment/streamapp-livekit -n streamapp
```

## üìä –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏

### Nginx Load Balancer

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏:

1. **API —Å–µ—Ä–≤–µ—Ä—ã** (`api_backend`):
   - –ú–µ—Ç–æ–¥: `least_conn` (–Ω–∞–∏–º–µ–Ω—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)
   - –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è API –∑–∞–ø—Ä–æ—Å–æ–≤

2. **Frontend —Å–µ—Ä–≤–µ—Ä—ã** (`frontend_backend`):
   - –ú–µ—Ç–æ–¥: `ip_hash` (–ø—Ä–∏–≤—è–∑–∫–∞ –ø–æ IP)
   - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–π

3. **LiveKit —Å–µ—Ä–≤–µ—Ä—ã** (`livekit_backend`):
   - –ú–µ—Ç–æ–¥: `ip_hash` (–ø—Ä–∏–≤—è–∑–∫–∞ –ø–æ IP)
   - –í–∞–∂–Ω–æ –¥–ª—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

### Kubernetes

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π LoadBalancer
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –º–µ–∂–¥—É —Ä–µ–ø–ª–∏–∫–∞–º–∏
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

## üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û–±—â–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –∫–∞–∫ master –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∫ –Ω–µ–º—É:

```javascript
// –í streamApp/server/db.js
// –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–¥–∞–ª–µ–Ω–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†–µ–ø–ª–∏–∫–∞—Ü–∏—è

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏ (–±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ).

## üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö

```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç update-all.sh –Ω–∞ –æ—Å–Ω–æ–≤–µ deploy-to-all-servers.sh
# –ù–æ –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è, —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Git (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)

```bash
# –ù–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ
cd /www/wwwroot/LiveKit
git pull
cd streamApp && npm install
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã
```

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

```bash
ssh -p 16205 root@195.133.17.131
cd /www/wwwroot/LiveKit
./check-services.sh
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤

```bash
./check-all-servers.sh
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# –ù–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ
tail -f /tmp/livekit.log
tail -f /tmp/api.log
tail -f /tmp/frontend.log
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **Firewall**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ firewall –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö
2. **SSH**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª—é—á–∏ –≤–º–µ—Å—Ç–æ –ø–∞—Ä–æ–ª–µ–π
3. **SSL**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è Nginx
4. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Nginx —Å—Ç–∞—Ç—É—Å

```bash
# –í–∫–ª—é—á–∏—Ç–µ stub_status –≤ Nginx
# –î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
location /nginx_status {
    stub_status on;
    access_log off;
}
```

### Kubernetes –º–µ—Ç—Ä–∏–∫–∏

```bash
kubectl top pods -n streamapp
kubectl top nodes
```

## üö® –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 502 Bad Gateway

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ firewall –ø—Ä–∞–≤–∏–ª–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Nginx

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è

- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞ —Å –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

### WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ LiveKit —Å–µ—Ä–≤–µ—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç WebSocket

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx/K8s

