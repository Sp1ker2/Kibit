⚠️ ПРОБЛЕМА: WebSocket не подключается к LiveKit

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

СИМПТОМЫ:
- Стрим запускается (getDisplayMedia работает)
- LiveKit не подключается (Timeout)
- Ошибка: "Не удалось подключиться к LiveKit серверу"

ПРИЧИНА: Nginx неправильно проксирует WebSocket на /rtc

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

БЫСТРОЕ ИСПРАВЛЕНИЕ:

Выполните на сервере:

sudo bash /www/wwwroot/LiveKit/fix-websocket-connection.sh

Скрипт:
- Проверит LiveKit сервер
- Проверит SSL сертификат
- Создаст правильную конфигурацию Nginx для WebSocket
- Перезагрузит Nginx

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ВАЖНЫЕ ПАРАМЕТРЫ ДЛЯ WEBSOCKET:

В конфигурации Nginx должны быть:

location /rtc {
    proxy_pass http://127.0.0.1:7880/rtc;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
    proxy_buffering off;
    proxy_set_header Origin "";
}

Обратите внимание:
- proxy_pass должен заканчиваться на /rtc
- Обязательно: Upgrade и Connection headers
- proxy_buffering off - для WebSocket
- proxy_read_timeout 86400 - длительный таймаут

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ПОСЛЕ ИСПРАВЛЕНИЯ:

1. Обновите страницу в браузере (Ctrl+F5)
2. Откройте консоль (F12)
3. Проверьте логи подключения:
   - Должен быть лог: "Подключаемся к серверу: wss://..."
   - Не должно быть Timeout ошибки
4. В Network tab найдите WebSocket подключение:
   - Статус должен быть: 101 Switching Protocols
   - Если 404 - Nginx не находит /rtc
   - Если 502 - LiveKit не отвечает
5. Попробуйте запустить стрим

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ЕСЛИ ВСЕ ЕЩЕ НЕ РАБОТАЕТ:

1. Проверьте логи LiveKit:
   tail -20 /tmp/livekit.log

2. Проверьте логи Nginx:
   tail -20 /var/log/nginx/error.log

3. Проверьте что LiveKit отвечает напрямую:
   curl -I http://localhost:7880

4. Проверьте WebSocket через Nginx:
   curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" \
        -H "Sec-WebSocket-Key: test" -H "Sec-WebSocket-Version: 13" \
        https://kibitkostreamappv.pp.ua/rtc

   Должен вернуть: 101 Switching Protocols

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

После исправления WebSocket должен подключиться!

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

